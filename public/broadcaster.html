<!DOCTYPE html>
<html>
<head>
  <title>Broadcaster (C√°mara Frontal)</title>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body { font-family: Arial; background: #111; color: #eee; text-align:center; }
    video { width:90%; border:3px solid #4caf50; border-radius:8px; margin-top:20px; }
    input, button { padding:12px; font-size:18px; margin:10px; border-radius:8px; }
  </style>
</head>
<body>

<h1>üì° Emisi√≥n en directo</h1>

<p>Introduce un PIN para proteger el acceso:</p>
<input id="pinInput" type="password" placeholder="PIN" />

<button id="startBtn">Iniciar transmisi√≥n</button>

<video id="localVideo" autoplay playsinline></video>

<script>
let localStream;
let peer;
let streamId = "stream-" + Math.random().toString(36).substr(2, 9);

// 1Ô∏è‚É£ Obtener c√°mara frontal con compatibilidad Android 7
async function getFrontCompatibleStream() {
  // Paso A: intentar facingMode "user"
  let constraints = {
    audio: true,
    video: { facingMode: "user", width: 640, height: 480 }
  };

  try {
    return await navigator.mediaDevices.getUserMedia(constraints);
  } catch (e1) {
    console.warn("Falla facingMode ‚Üí usando enumeraci√≥n", e1);
  }

  // Paso B: enumerar c√°maras y elegir la frontal por deviceId
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videos = devices.filter(d => d.kind === "videoinput");

    let front = videos.find(v => v.label.toLowerCase().includes("front"));
    let id = front ? front.deviceId : (videos[1]?.deviceId || videos[0]?.deviceId);

    return await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: { deviceId: { exact: id }, width: 640, height: 480 }
    });

  } catch (e2) {
    console.warn("Falla deviceId ‚Üí √∫ltimo fallback", e2);
  }

  // Paso C: fallback final para Android muy problem√°ticos
  return await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: true
  });
}

document.getElementById("startBtn").onclick = async () => {
  const pin = document.getElementById("pinInput").value.trim();
  if (!pin) {
    alert("Debes introducir un PIN.");
    return;
  }

  // 2Ô∏è‚É£ Crear PeerJS
  peer = new Peer(streamId, {
    host: window.location.hostname,
    port: window.location.port,
    path: "/peerjs",
    secure: true
  });

  // 3Ô∏è‚É£ Obtener c√°mara frontal
  localStream = await getFrontCompatibleStream();
  document.getElementById("localVideo").srcObject = localStream;

  // 4Ô∏è‚É£ Cuando viewer pide la conexi√≥n, enviar stream
  peer.on("call", call => {
    call.answer(localStream);
  });

  // 5Ô∏è‚É£ Guardar PIN en el servidor vinculado al streamId
  await fetch("/set-pin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ streamId, pin })
  });

  alert("Transmisi√≥n iniciada.\nEl viewer podr√° conectarse con tu PIN.");
};
</script>
</body>
</html>
