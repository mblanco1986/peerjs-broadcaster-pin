<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Broadcaster (con PIN)</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b0b0b; color:#fff; text-align:center; padding:16px; }
    video { width:100%; max-width:720px; border-radius:8px; background:#000; }
    input, button { padding:10px; margin-top:8px; width:100%; max-width:720px; box-sizing:border-box; }
    .small { font-size:0.9rem; color:#ccc; margin-top:8px; }
  </style>
</head>
<body>
  <h1>üì± Broadcaster ‚Äî Inicia emisi√≥n</h1>
  <p class="small">Abre esta p√°gina en el navegador de tu Android, permite c√°mara y micro.</p>

  <video id="localVideo" autoplay playsinline muted></video>

  <div>
    <input id="pinInput" placeholder="PIN de 4-6 d√≠gitos (ej. 1234)" />
    <button id="startBtn">‚ñ∂Ô∏è Iniciar transmisi√≥n</button>
    <button id="stopBtn" disabled>‚èπÔ∏è Parar transmisi√≥n</button>
  </div>

  <p class="small">Tu ID (c√≥pialo o toca para generar enlace de viewer):</p>
  <input id="myId" readonly />

  <div style="margin-top:8px;">
    <button id="shareWhats" disabled>üì§ Compartir por WhatsApp</button>
  </div>
  
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <script>
    const peerHost = window.location.hostname;
    const peerPort = window.location.port || (window.location.protocol === 'https:' ? 443 : 80);
    const peerPath = '/peerjs';

    const peer = new Peer(undefined, {
      host: peerHost,
      port: peerPort,
      path: peerPath,
      secure: window.location.protocol === 'https:'
    });

    const localVideo = document.getElementById('localVideo');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const myIdInput = document.getElementById('myId');
    const pinInput = document.getElementById('pinInput');
    const shareWhats = document.getElementById('shareWhats');

    let localStream = null;

    peer.on('open', id => {
      myIdInput.value = id;
      shareWhats.disabled = false;
    });

    peer.on('error', err => {
      console.error('Peer error', err);
      alert('Error de Peer: ' + err);
    });

    // Responder llamadas de viewers
    peer.on('call', call => {
      if (!localStream) {
        alert('Pulsa "Iniciar transmisi√≥n" primero.');
        return;
      }
      call.answer(localStream); // enviamos nuestro stream al viewer
    });

    async function startCapture() {
      const pin = (pinInput.value || '').trim();
      if (!/^\d{3,6}$/.test(pin)) {
        alert('Introduce un PIN v√°lido de 3-6 d√≠gitos.');
        return;
      }

      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          let constraints = {
  audio: true,
  video: { width: 320, height: 240 }
};

try {
  localStream = await navigator.mediaDevices.getUserMedia(constraints);
} catch (e1) {
  // fallback para Android 7
  constraints = { audio: true, video: true };
  localStream = await navigator.mediaDevices.getUserMedia(constraints);
}

            
        });
        localVideo.srcObject = localStream;
        startBtn.disabled = true;
        stopBtn.disabled = false;

        // Registrar en el servidor el id + pin
        const id = myIdInput.value;
        await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, pin })
        });

        // Opcional: renovar peri√≥dicamente (cada 10 min) para que no expire mientras transmites
        setInterval(() => {
          fetch('/renew', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, pin })
          }).catch(()=>{});
        }, 1000 * 60 * 10);

      } catch (e) {
        console.error('getUserMedia error', e);
        alert('No se pudo acceder a la c√°mara/micr√≥fono: ' + e.message);
      }
    }

    function stopCapture() {
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        localVideo.srcObject = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.addEventListener('click', startCapture);
    stopBtn.addEventListener('click', stopCapture);

    function getViewerLink() {
      const id = myIdInput.value;
      if (!id) return '';
      return `${window.location.origin}/viewer.html?id=${encodeURIComponent(id)}`;
    }

    // Compartir por WhatsApp (abrewa con texto y enlace)
    shareWhats.addEventListener('click', () => {
      const link = getViewerLink();
      const pin = pinInput.value || '';
      if (!link) { alert('A√∫n no hay ID disponible'); return; }
      const msg = encodeURIComponent(`Ver mi transmisi√≥n en directo:\n${link}\nPIN: ${pin}\n(Abre en el navegador y pega el PIN)`);
      const wa = `https://wa.me/?text=${msg}`;
      window.open(wa, '_blank');
    });

    // Copiar link al tocar el campo ID
    myIdInput.addEventListener('click', async () => {
      const link = getViewerLink();
      if (link) {
        try {
          await navigator.clipboard.writeText(link);
          alert('Enlace copiado al portapapeles:\n' + link);
        } catch {
          myIdInput.select();
        }
      }
    });
  </script>
</body>
</html>
